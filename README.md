   Техническая документация проекта Telegram Case Bot

1. Введение

1.1 Описание проекта

Telegram Case Bot — бот в Telegram для загрузки политических кейсов в формате PDF, анализа через OpenAI и возвращения рекомендаций пользователю.

1.2 Основные функции

- Интерфейс с кнопками: Удобное взаимодействие с пользователем через настраиваемые кнопки и автоматические уведомления.
- Пользовательское соглашение: Пользователь обязан принять соглашение перед загрузкой файлов.
- Загрузка PDF-файлов: Возможность загружать политические кейсы в формате PDF для анализа.
- Анализ данных: Обработка загруженного текста с помощью OpenAI API для выявления несоответствий и формирования рекомендаций.
- Создание отчетов: Генерация PDF-отчетов с результатами анализа для отправки пользователю.
- Обработка ошибок и уведомления: Уведомление пользователя об ошибках и предоставление опции связи с поддержкой.
- Логирование: Запись всех событий и ошибок для последующего анализа и диагностики.
2. Архитектура проекта

telegram_case_bot/
│
├── README.md                   # Файл с описанием проекта, инструкциями по установке и использованию
├── api_key.txt                 # Файл для хранения API-ключа, используется для подключения к внешним сервисам
├── bot.py                      # Основной файл запуска бота с логикой взаимодействия с пользователями
├── config.py                   # Конфигурационный файл с настройками и ключами API
│
├── data/                       # Каталог для данных, которые используются ботом
│   └── templates/              # Шаблоны для создания PDF-отчетов или других файлов
│
├── encryption_key.key          # Файл с ключом для шифрования данных, если необходимо защитить данные
├── generate_key.py             # Скрипт для генерации ключа шифрования
├── htmlcov/                    # Папка для HTML-отчета по покрытию кода тестами
│
├── load_key.py                 # Скрипт для загрузки шифровального ключа
├── logging_config.py           # Настройки логирования для записи ошибок и важных событий
├── logs/                       # Папка для хранения логов, записей событий и ошибок
│
├── openai_api.py               # Модуль для связи с OpenAI API, используется для анализа текста и генерации рекомендаций
├── pdf_processing.py           # Модуль для обработки PDF-файлов и извлечения текста
├── report_generator.py         # Модуль для создания PDF-отчетов с результатами анализа
│
├── requirements.txt            # Список зависимостей и библиотек, необходимых для проекта
├── structure.txt               # Файл, содержащий структуру проекта (для внутренней документации)
│
├── tests/                      # Папка для тестов, которые проверяют функциональность отдельных модулей
│   ├── test_bot_integration.py # Тесты для интеграции бота с модулями проекта
│   ├── test_my_code.py         # Дополнительные тесты для кода (по требованию)
│   ├── test_openai_api.py      # Тесты для проверки работы с OpenAI API
│   ├── test_pdf_processing.py  # Тесты для обработки PDF-файлов
│   └── test_report_generator.py# Тесты для генерации отчетов
│
└── venv/                       # Виртуальное окружение Python с установленными библиотеками проекта




1.3 Обзор документации

Telegram Case Bot — это бот для анализа политических кейсов в формате PDF. Пользователи загружают документ в бот, который обрабатывает текст через OpenAI API и предоставляет рекомендации.

#### Основные функции
1. **Интерфейс**: Взаимодействие через настраиваемые кнопки.
2. **Загрузка и анализ PDF**: Пользователь загружает PDF, текст анализируется, и на выходе создается отчет.
3. **Ошибки и уведомления**: Бот уведомляет о сбоях и предоставляет возможность обратиться в поддержку.
4. **Логирование**: Ведение логов событий для диагностики и улучшения.

#### Структура проекта
Основные файлы и директории:
- **bot.py** — основная логика работы бота.
- **config.py** — файл с конфигурацией и API-ключами.
- **pdf_processing.py** — извлечение текста из PDF.
- **openai_api.py** — отправка данных в OpenAI и получение ответа.
- **report_generator.py** — создание PDF-отчета.
- **logs/** — хранение логов для отслеживания ошибок.
- **tests/** — тесты для проверки модулей.

#### Используемые технологии
- **Python 3.10** — основной язык программирования.
- **Ключевые библиотеки**:
    - `python-telegram-bot` — взаимодействие с Telegram API.
    - `openai` — для анализа текста.
    - `pdfplumber` — извлечение текста из PDF.
    - `reportlab` — генерация отчетов.
    - `cryptography` — шифрование данных.

#### Установка и настройка
1. Установить Python 3.10 и необходимые библиотеки (см. `requirements.txt`).
2. Заполнить `config.py` значениями для API-ключей и других параметров.
3. Убедиться в правильности логов и настройке шифрования.

#### Безопасность
- **Шифрование**: Перед отправкой данных в OpenAI используется AES-256.
- **Логирование**: Записываются только технические данные, чтобы защитить конфиденциальность пользователей.

#### Тестирование
Рекомендуется использовать `pytest` для юнит-тестов и интеграционных тестов. Тесты покрывают ключевые функции, такие как обработка PDF и взаимодействие с OpenAI.

#### Поддержка и отладка
1. **Типовые ошибки**: Документация описывает, как устранить ошибки при загрузке файлов, взаимодействии с API и генерации отчетов.
2. **Контакты**: Возможность обратиться в техническую поддержку через указанные каналы.

#### Системы мониторинга и аналитики
Для улучшения стабильности проекта рекомендуются:
- **Sentry** — отслеживание ошибок.
- **Prometheus и Grafana** — сбор и визуализация метрик, таких как время отклика и количество запросов.

Этот краткий обзор документации по проекту Telegram Case Bot поможет быстро освоить основные аспекты разработки, настройки, безопасности и тестирования системы.

2.1 Общая структура

bot.py
Основной модуль, отвечающий за взаимодействие с Telegram API. Реализует логику пользовательского интерфейса, включая кнопки, получение PDF-файлов от пользователей и отправку уведомлений об ошибках. Взаимодействует с модулями для обработки PDF-документов, работы с OpenAI API, генерации отчетов и логирования событий и ошибок.

config.py
Файл конфигурации, в котором хранятся токены и ключи API, такие как Telegram Bot Token, OpenAI API Key и параметры для шифрования. Обеспечивает доступ к данным конфигурации для всех модулей.

pdf_processing.py
Содержит функции для обработки загруженных PDF-файлов, включая извлечение текста для дальнейшего анализа. Использует библиотеки, такие как PyMuPDF или pdfplumber, для обработки PDF-документов.

openai_api.py
Модуль для формирования и отправки запросов к OpenAI API. Обрабатывает ответы от OpenAI и подготавливает их для использования в других модулях, таких как генерация отчетов.

report_generator.py
Создает PDF-отчеты для пользователей на основе данных, полученных от OpenAI. Использует библиотеку reportlab для генерации PDF-документов.

logging_config.py
Конфигурирует логирование, чтобы сохранять технические ошибки и события в лог-файлы без конфиденциальных данных. Настроено на запись логов в файл logs/bot_errors.log, что упрощает отслеживание ошибок.

data/templates/
Папка для хранения шаблонов и данных, необходимых для создания отчетов в формате PDF, если требуется специфическое форматирование.

logs/
Папка для хранения логов технических ошибок и событий, что позволяет удобно управлять и анализировать журналы.

2.2 Основные модули

	•	bot.py: Основной файл, управляющий логикой бота и взаимодействием с пользователем.
	•	pdf_processing.py: Модуль для обработки PDF-файлов и извлечения текста.
	•	openai_api.py: Модуль для обращения к API OpenAI.
	•	report_generator.py: Модуль для генерации отчетов в формате PDF.
	•	logging_config.py: Настройка и конфигурация логирования ошибок и технических событий.

2.3 Поток взаимодействия

	1.	Пользователь принимает соглашение.
	2.	Загружает PDF-файл.
	3.	Бот обрабатывает PDF-файл с помощью Pdfplumber, шифрует данные и отправляет текст в OpenAI.
	4.	Бот получает результаты, создаёт отчет (PDF) с помощью reportlab и отправляет пользователю.
	5.	В случае ошибки — уведомление пользователю и владельцу и логирование для владельца.

Раздел 2.4: Поток обработки данных и запросов

	•	Инициализация и безопасное соединение
Бот запускается с использованием python-telegram-bot, обеспечивая взаимодействие с Telegram API через SSL/TLS. Это защищает передаваемые данные от перехвата.
	•	Загрузка и обработка PDF-файла
После загрузки пользователем PDF-файла бот использует pdf_processing.py и библиотеку Pdfplumber для извлечения текста, который затем подготавливается для отправки в OpenAI.
	•	Шифрование данных
Данные шифруются с помощью библиотеки cryptography, чтобы сохранить конфиденциальность на этапе передачи.
	•	Запрос к OpenAI и обработка ответа
Отправка текста в OpenAI происходит через openai_api.py. Запрос включает параметры, такие как используемая модель, ограничение на длину ответа и другие настройки. Бот получает и обрабатывает ответ для подготовки отчета.
	•	Генерация отчета
Бот использует report_generator.py и reportlab для создания PDF-отчета на основе данных OpenAI. Отчет содержит основные выводы и рекомендации.
	•	Логирование взаимодействий и событий
На каждом этапе выполнения операций ведется логирование через logging_config.py. Логи сохраняются в /logs, что облегчает диагностику ошибок и анализ работы бота.


3. Используемые технологии




3.1 Язык программирования

	•	Python 3.13

3.2 Библиотеки и зависимости

Telegram Case Bot использует следующие ключевые библиотеки для работы с API, обработки данных и генерации отчетов. Эти зависимости обеспечивают стабильность, безопасность и эффективность работы бота.

- python-telegram-bot: Взаимодействие с Telegram API, создание интерфейса и обработка сообщений.
- openai: Подключение к OpenAI API для анализа загружаемого текста и генерации рекомендаций.
- pdfplumber: Извлечение текста из PDF-документов для дальнейшего анализа.
- reportlab: Генерация PDF-отчетов с настройкой визуальных элементов.
- cryptography: Шифрование данных перед отправкой на обработку в OpenAI.
- logging: Стандартная библиотека Python для отслеживания событий и ошибок.

3.2.1 Версии библиотек

Для обеспечения стабильности и совместимости всех компонентов проекта зависимости зафиксированы в файле requirements.txt с указанием конкретных версий библиотек. Это снижает риск конфликтов между версиями и повышает надёжность приложения. Пример содержимого файла requirements.txt:

python-telegram-bot==13.7
openai==0.10.2
pdfplumber==0.5.28
reportlab==3.6.8
cryptography==3.4.7
pytest==8.3.3
pytest-cov==6.0.0
coverage==7.3.1

Для стабильной работы с Python 3.10 рекомендуется использовать указанные версии. При обновлении библиотек рекомендуется проводить тестирование для подтверждения совместимости с ботом.



3.3 Среда развертывания

	•	SSL/TLS для защиты данных.

3.4 Структура и важность библиотек

В Telegram Case Bot используются следующие ключевые библиотеки, каждая из которых выполняет важные функции для обеспечения стабильности, безопасности и удобства использования бота. Ниже представлены описания каждой библиотеки и их взаимосвязь в процессе работы.

Основные библиотеки

	1.	python-telegram-bot
	•	Описание: Библиотека python-telegram-bot предоставляет интерфейс для взаимодействия с Telegram API и обработку сообщений и событий из Telegram. Она упрощает создание пользовательского интерфейса для бота, позволяет обрабатывать команды, загружать файлы и уведомлять пользователей о результатах работы.
	•	Роль в проекте: Это основная библиотека для создания бота, которая управляет взаимодействием с пользователями, получает их запросы, обрабатывает команды, инициализирует загрузку файлов и отправляет сообщения об ошибках и результатах.
	•	Взаимосвязь: python-telegram-bot работает в тандеме с другими модулями, такими как pdf_processing.py и report_generator.py, обеспечивая выполнение запросов и доставку результатов пользователю.
	2.	pdfplumber
	•	Описание: pdfplumber используется для извлечения текста из PDF-документов. Эта библиотека поддерживает работу с многостраничными и текстово насыщенными PDF-файлами, что позволяет боту обрабатывать сложные документы для анализа.
	•	Роль в проекте: Эта библиотека критически важна для подготовки текста из загруженного PDF-документа, который затем отправляется для анализа. Она позволяет извлекать текст и передавать его в OpenAI API для дальнейшей обработки.
	•	Взаимосвязь: pdfplumber тесно интегрирована с модулем openai_api.py, так как её задача — подготовить данные для анализа. Она также работает с модулем report_generator.py, обеспечивая наличие корректного текста для включения в финальный отчет.
	3.	cryptography
	•	Описание: cryptography используется для шифрования данных перед их передачей, обеспечивая защиту конфиденциальной информации. В проекте применяется алгоритм AES-256, который гарантирует безопасность передаваемых данных.
	•	Роль в проекте: Эта библиотека защищает данные пользователей, шифруя их перед отправкой на анализ в OpenAI. Она снижает риск утечки данных и повышает уровень безопасности системы.
	•	Взаимосвязь: cryptography взаимодействует с модулем openai_api.py, так как данные перед отправкой на анализ шифруются. Она также использует настройки из файла config.py для управления ключами шифрования.
	4.	openai
	•	Описание: Библиотека openai обеспечивает доступ к OpenAI API, что позволяет отправлять текст на обработку и получать результаты. OpenAI API помогает в анализе и обработке данных, извлечённых из загруженных PDF-файлов.
	•	Роль в проекте: Основной инструмент анализа текста. Библиотека обрабатывает текст, отправляет запросы в OpenAI и возвращает результаты, которые затем включаются в отчет для пользователя.
	•	Взаимосвязь: openai тесно связана с модулями pdf_processing.py и report_generator.py. После обработки текста модулем pdfplumber, текст передается в OpenAI для анализа, а полученные данные используются для создания PDF-отчета.
	5.	reportlab
	•	Описание: Библиотека reportlab используется для создания PDF-отчетов с результатами анализа. Она предоставляет гибкие возможности для форматирования, добавления таблиц, заголовков и логотипов в отчет.
	•	Роль в проекте: После анализа текста OpenAI API, reportlab создает итоговый отчет, который отправляется пользователю. Отчет может содержать выводы, выявленные несоответствия и персонализированные рекомендации.
	•	Взаимосвязь: reportlab работает на завершающем этапе, принимая данные от openai_api.py и генерируя итоговый отчет, который отправляется через python-telegram-bot.
	6.	logging
	•	Описание: Встроенная библиотека logging используется для отслеживания ошибок и ключевых событий, возникающих во время работы бота.
	•	Роль в проекте: Логирование обеспечивает контроль над стабильностью бота, записывает ошибки и другие важные события, что позволяет быстрее реагировать на потенциальные сбои и устранять проблемы.
	•	Взаимосвязь: logging интегрирована во все основные модули бота и поддерживает работу с папкой /logs, куда сохраняются файлы с логами ошибок и событий.

Заключение

Эти библиотеки являются основой работы Telegram Case Bot, обеспечивая все ключевые процессы, от взаимодействия с пользователем до анализа загруженных данных и формирования отчетов. Их интеграция позволяет системе работать с высокой степенью автоматизации, безопасности и стабильности.

3.4.1 Возможные проблемы при одновременном использовании нескольких библиотек

В проекте Telegram Case Bot используются несколько библиотек, включая pdfplumber для обработки PDF и reportlab для генерации отчетов в формате PDF. Несмотря на то, что каждая из них выполняет уникальные функции, их совместное использование требует учета потенциальных проблем совместимости.

Основные возможные проблемы:

- Конфликты зависимостей: Некоторые библиотеки могут иметь противоречивые зависимости или требовать разные версии одной и той же зависимости, что приводит к ошибкам при установке или запуске бота.
- Проблемы с ресурсами: pdfplumber и reportlab могут потреблять значительные ресурсы при обработке больших файлов или создании сложных отчетов. Их одновременное использование без оптимизации может привести к высокой нагрузке на процессор и память, замедляя работу бота.
- Ошибки рендеринга PDF: Иногда могут возникать проблемы с отображением текста или форматов при последовательной обработке одного и того же файла обеими библиотеками, так как pdfplumber предназначен для извлечения текста, а reportlab — для создания нового документа. Это может вызвать несоответствие форматов, особенно если исходный документ имеет сложное форматирование.

Рекомендации для устранения потенциальных проблем:

1. Фиксация версий библиотек: В requirements.txt должны быть зафиксированы конкретные версии pdfplumber и reportlab, которые совместимы между собой. Это предотвратит проблемы с зависимостями при установке.

2. Оптимизация нагрузки на систему: Ограничение на максимальный размер обрабатываемых PDF-файлов, а также контроль за используемой памятью при генерации отчетов. Это снизит нагрузку на сервер и ускорит обработку данных.

3. Тестирование на совместимость: Перед развертыванием рекомендуется протестировать основные функции, используя PDF-файлы разного объема и форматов. Это позволит убедиться, что pdfplumber и reportlab корректно работают с различными типами данных.

Эти меры позволят минимизировать возможные ошибки и конфликты, обеспечивая стабильную работу Telegram Case Bot при использовании нескольких библиотек для работы с PDF.

3.5 Влияние на работоспособность системы

- OpenAI API: Зависимость от OpenAI API может привести к сбоям в работе бота при недоступности сервиса или превышении лимитов запросов. Это может затруднить предоставление результатов пользователям. Важно предусмотреть механизмы для обработки ошибок API, включая повторные попытки при неудачных запросах, установление тайм-аутов и уведомление пользователей о задержках. 

- Механизмы обработки ошибок и альтернативные решения: Для обеспечения надежности бота, в случае превышения лимитов или недоступности API, целесообразно использовать следующие подходы:
    - Повторные попытки запросов: Настроить количество повторных попыток и задержки между ними.
    - Локальное кэширование: В случае временной недоступности API кэшировать последние результаты или использовать локальные шаблоны ответов.
    - Уведомление пользователя: Информировать пользователя о возникшей проблеме и рекомендовать повторить попытку позже.
    
Эти меры помогут снизить зависимость от OpenAI API и поддерживать стабильную работу Telegram Case Bot.

4. Установка и настройка

4.1 Требования

	•	Python 3.10
	•	Аккаунт и API ключи для Telegram и OpenAI

4.2 Конфигурация

Для корректной работы Telegram Case Bot требуется настроить файл config.py, в котором будут храниться все необходимые параметры конфигурации. Файл config.py содержит ключи API, настройки шифрования и другие параметры, необходимые для работы бота. Описание основных конфигураций:

	•	TELEGRAM_BOT_TOKEN: Токен, полученный при создании бота в Telegram. Этот токен позволяет боту подключаться к Telegram API и обрабатывать сообщения пользователей.
	•	OPENAI_API_KEY: Ключ API для доступа к OpenAI. Он используется для отправки запросов на анализ данных, извлечённых из загруженных PDF-файлов, и получения ответов от модели.
	•	ENCRYPTION_KEY: Ключ для шифрования данных перед передачей в OpenAI API. Для этого используется библиотека cryptography. Ключ шифрования обеспечивает безопасность конфиденциальных данных при их обработке.
	•	LOGGING_LEVEL: Уровень логирования, который задаёт уровень детализации информации, записываемой в лог-файлы. Возможные уровни включают DEBUG, INFO, WARNING, ERROR, и CRITICAL. Рекомендуется устанавливать INFO для рабочих версий и DEBUG для отладки.
	•	PDF_PROCESSING_SETTINGS: Параметры для модуля обработки PDF-файлов. Могут включать настройки по размерам загружаемых файлов, форматам, и методам извлечения текста.
	•	REPORT_TEMPLATE_PATH: Путь к шаблону отчета в формате PDF, который будет использоваться для создания отчетов. Этот параметр позволяет указать конкретный шаблон для улучшения унификации отчетов.

Файл config.py должен быть защищён и не должен быть доступен для посторонних, так как содержит конфиденциальные данные, включая API-ключи.



5. Безопасность

5.1 Шифрование данных

	•	Шифрование перед отправкой в OpenAI: Перед отправкой данных из загруженных PDF-файлов в OpenAI API бот шифрует их с использованием алгоритма AES-256 (Advanced Encryption Standard) из библиотеки cryptography. Этот метод обеспечивает высокий уровень безопасности, защищая данные от перехвата и несанкционированного доступа во время передачи.
	•	Хранение ключей шифрования: Ключ шифрования (ENCRYPTION_KEY) хранится в конфигурационном файле config.py, доступ к которому ограничен. В целях повышения безопасности рекомендуется использовать переменные окружения для хранения ключей шифрования, чтобы избежать их прямого хранения в коде.

5.2 Логирование без конфиденциальной информации

	•	Ограничение логируемых данных: Для защиты конфиденциальности данные, которые бот записывает в логи, не содержат чувствительной информации, такой как личные данные пользователей или содержимое загруженных документов. Логирование ограничено технической информацией: коды ошибок, статусы выполнения задач, временные метки и идентификаторы запросов. Это позволяет администратору отслеживать состояние работы бота и диагностировать ошибки без компрометации данных пользователей.
	•	Защита логов: Лог-файлы хранятся в папке /logs с доступом только для администратора системы. Это ограничивает риск несанкционированного доступа к логам и снижает вероятность утечек данных. Файлы логов автоматически архивируются и удаляются через определённый период, чтобы предотвратить накопление данных и минимизировать возможные риски.

6. Обработка ошибок и уведомления

6.1 Логирование ошибок

	•	Конфигурация логирования: В модуле logging_config.py настроено логирование всех ошибок и событий, связанных с работой бота. Логи сохраняются в файлах в папке /logs, что позволяет администратору отслеживать и анализировать ошибки и поведение бота.
	•	Содержание логов: Логи содержат следующую информацию:
	•	Коды ошибок и описание возникающих исключений.
	•	Временные метки, идентификаторы запросов и статусы задач для быстрого поиска проблем.
	•	Ключевые технические данные, исключая конфиденциальную информацию, что помогает отслеживать состояние бота, не нарушая конфиденциальность данных пользователей.

6.2 Уведомления об ошибках

	•	Информирование пользователей: В случае возникновения ошибок бот уведомляет пользователя с помощью заранее настроенного сообщения. Это сообщение включает описание проблемы и рекомендации по дальнейшим действиям.
	•	Процедура связи с поддержкой: Если ошибка не решается автоматически, пользователю предлагается связаться с технической поддержкой. Для этого бот предоставляет информацию о возможных способах связи (например, адрес электронной почты или ссылку на контактный центр), что помогает пользователю оперативно получить помощь.

6.3 Логирование запросов и уведомления об ошибках

	•	Логирование запросов к OpenAI API: Каждое обращение к OpenAI API и его результат записываются в логи. Это помогает отследить частоту и успешность запросов, а также диагностировать ошибки, связанные с интеграцией API.
	•	Уведомление об ошибках API: В случае проблем при обращении к OpenAI API, таких как превышение лимитов запросов, бот немедленно отправляет уведомление пользователю с объяснением причины задержки. Ошибка также записывается в лог для дальнейшего анализа, чтобы администратор мог быстро предпринять необходимые меры для восстановления работоспособности.

6.4 Шаблоны расширенных уведомлений

Для улучшения взаимодействия с пользователем и повышения информативности предлагается внедрить шаблоны уведомлений, которые будут информировать о ходе выполнения процессов загрузки, анализа и генерации отчета. Уведомления позволят пользователю отслеживать прогресс выполнения запросов и получать понятные инструкции в случае ошибок.

Нотификации прогресса

Эти уведомления помогут пользователю отслеживать этапы выполнения запроса.

Примеры уведомлений:

# Уведомление о завершении загрузки файла
def notify_file_uploaded(bot, chat_id):
    message = "✅ Ваш файл успешно загружен. Начинается анализ данных, это может занять несколько минут."
    bot.send_message(chat_id=chat_id, text=message)

# Уведомление о начале анализа
def notify_analysis_started(bot, chat_id):
    message = "🔍 Анализ загруженного кейса начался. Мы проверяем документ на соответствие критериям. Это займет некоторое время."
    bot.send_message(chat_id=chat_id, text=message)

# Уведомление о создании отчета
def notify_report_generating(bot, chat_id):
    message = "⏳ Анализ завершен, и отчет готовится. Это займет всего несколько секунд."
    bot.send_message(chat_id=chat_id, text=message)

# Уведомление о готовности отчета
def notify_report_ready(bot, chat_id, report_file):
    message = "📄 Ваш отчет готов. Вы можете скачать его, нажав на кнопку ниже."
    bot.send_document(chat_id=chat_id, document=report_file, caption=message)

Контекстные уведомления об ошибках

В случае возникновения ошибки бот отправит уведомление с описанием возможных причин проблемы и рекомендациями для пользователя.

Примеры уведомлений:

# Ошибка загрузки файла
def notify_error_upload(bot, chat_id):
    message = "❌ Ошибка загрузки файла. Убедитесь, что загружаемый файл является PDF и его размер не превышает допустимый лимит."
    bot.send_message(chat_id=chat_id, text=message)

# Ошибка при извлечении текста из PDF
def notify_error_processing(bot, chat_id):
    message = "⚠️ Ошибка при обработке файла. Возможно, ваш PDF-документ содержит только изображения. Попробуйте загрузить файл с текстовым содержимым."
    bot.send_message(chat_id=chat_id, text=message)

# Ошибка при анализе OpenAI API
def notify_error_openai(bot, chat_id):
    message = "⚠️ Произошла ошибка при анализе кейса. Пожалуйста, попробуйте позже. Если проблема повторяется, обратитесь в техническую поддержку."
    bot.send_message(chat_id=chat_id, text=message)

# Ошибка генерации PDF-отчета
def notify_error_report(bot, chat_id):
    message = "⚠️ Не удалось создать отчет. Возможно, данные были получены с ошибкой. Пожалуйста, повторите попытку или свяжитесь с поддержкой."
    bot.send_message(chat_id=chat_id, text=message)

Заключение

Эти шаблоны уведомлений позволяют пользователю всегда оставаться в курсе этапов обработки и быстро реагировать в случае возникновения ошибок, что повышает качество взаимодействия и удовлетворенность от использования бота.

6.5 Обработка ошибок и устойчивость системы

6.5.1 Механизмы обработки ошибок

Для обеспечения стабильной работы Telegram Case Bot применяются следующие механизмы при возникновении ошибок:

	•	Повторные попытки при сбоях API: В случае временных сбоев в доступе к внешним сервисам, бот автоматически выполняет повторные попытки с нарастающим временем задержки (экспоненциальная задержка).
	•	Тайм-ауты для API-запросов: Все запросы к внешним API, таким как OpenAI, ограничены по времени ожидания, чтобы избежать зависаний в случае недоступности сервисов.
	•	Уведомления пользователя об ошибках: При возникновении ошибки, пользователю отображается сообщение с кратким описанием проблемы и предложением повторить запрос позже.

6.5.2 Логирование и мониторинг

Для контроля над работоспособностью и своевременного устранения сбоев в боте настроены:

	•	Логирование ошибок: Все ошибки записываются в лог-файлы через модуль logging_config.py. Эти логи помогают в диагностике проблем, возникающих в работе бота.
	•	Мониторинг и аналитика:
	•	Sentry: Интеграция с Sentry позволяет отслеживать и собирать информацию о возникающих исключениях и ошибках в реальном времени.
	•	Prometheus и Grafana: Используются для мониторинга ключевых метрик, таких как

7. Генерация отчетов

7.1 Структура PDF-отчета

	•	Состав отчета: Отчет, создаваемый с помощью модуля report_generator.py, включает результаты анализа, выполненного с помощью OpenAI API. Основные разделы отчета:
	•	Введение: Краткое описание загруженного кейса, включая дату анализа и основные параметры.
	•	Результаты анализа: Основные выводы и выявленные несоответствия в политическом кейсе, если таковые имеются. Данный раздел формируется на основе ответов, полученных от OpenAI.
	•	Рекомендации: Персонализированные рекомендации, подготовленные для пользователя в зависимости от анализа текста.
	•	Заключение: Резюме ключевых моментов и, при необходимости, дальнейшие действия.
	•	Структура и оформление: Используется библиотека reportlab, которая позволяет гибко настраивать визуальные элементы отчета, такие как:
	•	Заголовки и подзаголовки для четкой структуризации.
	•	Таблицы и списки для представления данных в удобной для восприятия форме.
	•	Логотип или другие элементы оформления для улучшения визуальной привлекательности (по мере необходимости).

7.2 Пример содержания отчета

	•	Описание примера: Пример отчета включает следующие разделы:
	•	Титульная страница: Название отчета, информация о пользователе, дата и уникальный идентификатор отчета.
	•	Результаты анализа: Например, «В загруженном кейсе выявлено несколько ключевых несостыковок, таких как…». Здесь выводы сформулированы в краткой и понятной форме.
	•	Рекомендации: Конкретные советы или дальнейшие шаги, такие как «Рекомендуется более подробно исследовать такие аспекты, как…».
	•	Заключение: Резюмирующее высказывание с основными выводами и, при необходимости, предложением на дальнейшее сотрудничество или обращение к дополнительной поддержке.
	•	Шаблоны для отчета: Хранятся в папке data/templates/

7.3: Автоматическая проверка на корректность данных

Для обеспечения корректности данных, загружаемых пользователями в Telegram Case Bot, рекомендуется добавить автоматическую проверку загружаемых PDF-файлов. Эти проверки позволят выявить возможные ошибки на начальном этапе и предотвратить дальнейшую обработку неподдерживаемых данных, что улучшит производительность и качество работы бота.

7.4 Автоматическая проверка на корректность данных

	1.	Сканирование на наличие текста
Telegram Case Bot перед отправкой PDF-файлов на анализ проверяет, содержит ли файл текстовую информацию, необходимую для дальнейшего анализа. Это особенно полезно, так как некоторые PDF-файлы могут содержать исключительно изображения, не поддающиеся текстовому анализу.
Техническая реализация:
	•	Использование модуля pdf_processing.py для сканирования содержимого файла.
	•	При обнаружении отсутствия текста бот отправляет пользователю уведомление с просьбой загрузить файл с текстовым содержимым.
	2.	Проверка на язык текста
Бот автоматически проверяет язык текста в загружаемом PDF-файле и уведомляет пользователя в случае неподдерживаемого языка. Это помогает избежать обработки данных, которые не могут быть корректно проанализированы текущими настройками OpenAI API.
Техническая реализация:
	•	Модуль pdf_processing.py извлекает текст из PDF-файла и использует библиотеку langdetect для определения языка.
	•	Если язык текста не поддерживается, бот отправляет пользователю уведомление с описанием ошибки и рекомендацией загрузить файл на поддерживаемом языке.

Порядок интеграции

	1.	Модификация модуля pdf_processing.py
	•	Добавить функции check_text_content и detect_language, которые будут вызываться при загрузке файла.
	2.	Обновление интерфейса уведомлений
	•	В случае неподдерживаемого формата или языка уведомлять пользователя через интерфейс Telegram.

Пример уведомлений для пользователей:

	•	Если PDF не содержит текст:
	“Загруженный файл не содержит текста, пригодного для анализа. Пожалуйста, загрузите текстовый PDF-файл.”
	•	Если язык текста не поддерживается:
	“Загруженный файл содержит текст на неподдерживаемом языке. Пожалуйста, загрузите документ на поддерживаемом языке.”

Заключение

Автоматическая проверка на корректность данных повысит точность и надежность анализа, предоставляемого Telegram Case Bot, улучшив пользовательский опыт и снижая вероятность ошибок.

8. Поддержка и отладка

8.1 Частые ошибки

	•	Ошибка загрузки PDF-файла
	•	Описание: Ошибка может возникнуть, если загружаемый файл не соответствует требуемому формату или превышает допустимый размер.
	•	Метод устранения: Убедитесь, что загружаемый файл — это PDF и его размер не превышает установленный лимит. В противном случае бот отправит пользователю уведомление с информацией о допустимых параметрах загрузки.
	•	Ошибка извлечения текста из PDF
	•	Описание: Возникает при обработке PDF-файлов, если файл имеет нестандартное форматирование или зашифрован.
	•	Метод устранения: Проверьте формат файла и убедитесь, что он не защищен паролем. Модуль pdf_processing.py поддерживает только текстовые PDF. Если проблема сохраняется, рекомендуется преобразовать документ в стандартный PDF с текстовым слоем.
	•	Ошибка взаимодействия с OpenAI API
	•	Описание: Может возникнуть из-за проблем с API-ключом, превышения лимитов запросов или временной недоступности OpenAI API.
	•	Метод устранения: Проверьте действительность API-ключа в config.py и убедитесь, что он не превысил установленный лимит запросов. Если проблема связана с перегрузкой сервера OpenAI, попробуйте повторить запрос позже.
	•	Ошибка генерации PDF-отчета
	•	Описание: Ошибка возникает при формировании PDF-отчета, если в ответе от OpenAI содержатся некорректные данные или данные не соответствуют шаблону.
	•	Метод устранения: Проверить корректность данных, возвращаемых от OpenAI, и отладить шаблон в report_generator.py. В случае обнаружения ошибки бот уведомляет пользователя о невозможности сформировать отчет.
	•	Ошибка логирования
	•	Описание: Ошибка может возникнуть при записи логов, если папка /logs недоступна или отсутствует.
	•	Метод устранения: Убедитесь, что папка /logs существует и имеет правильные разрешения на запись. При необходимости создайте папку вручную или настройте путь для логирования в logging_config.py.

8.2 Контакты для поддержки

	•	Электронная почта: Пользователи могут отправлять сообщения с описанием проблемы на адрес технической поддержки, например, support@example.com.
	•	Telegram-канал или чат поддержки: В случае возникновения вопросов или технических проблем пользователи могут обратиться в специальный канал или чат поддержки в Telegram. Информация о канале указана в меню бота или доступна при возникновении ошибки.
	•	Дополнительные ресурсы: В случае распространенных проблем бот может автоматически предоставить пользователю ссылки на FAQ или инструкции по устранению неполадок.

Ниже представлен новый раздел “9. Тестирование” с описанием тестов, необходимых для Telegram Case Bot, а также рекомендациями по тестированию и использованию тестовых инструментов.

Переписываю раздел “9. Тестирование” с учетом улучшений:

9. Тестирование

Тестирование Telegram Case Bot необходимо для обеспечения стабильной работы и корректного функционирования всех модулей. Тесты покрывают ключевые компоненты, включая обработку PDF-файлов, взаимодействие с OpenAI API, генерацию отчетов и логирование. Этот раздел описывает типы тестов, инструменты и инструкции для тестирования.

9.1 Инструкции по запуску тестов

Для запуска тестов и проверки их корректного выполнения используется pytest. Убедитесь, что все зависимости установлены, и запустите тесты командой:

pytest tests/

Это позволит выполнить все тесты, находящиеся в папке tests, и отобразит результаты по каждому из них, включая потенциальные ошибки.

9.2 Отчет о покрытии тестами

Для проверки покрытия кода тестами используйте coverage. Этот инструмент позволяет оценить, какие участки кода протестированы, а какие нет, и получить общий процент покрытия. Это поможет целенаправленно добавлять тесты для недостаточно покрытых участков. Команды для запуска покрытия:

	1.	Запустите тесты с coverage:

coverage run -m pytest


	2.	Получите отчет:

coverage report


	3.	Для более детального анализа можно сгенерировать HTML-отчет:

coverage html



Сформированный HTML-отчет будет доступен в папке htmlcov. Откройте файл htmlcov/index.html в браузере для визуального представления покрытия кода тестами.

9.3 Типы тестов

Для полного охвата всех функциональных областей бота рекомендуется использовать следующие типы тестов:

	•	Юнит-тесты: Тестируют отдельные функции и методы в таких модулях, как pdf_processing.py и openai_api.py. Примеры:
	•	Проверка функций извлечения текста из PDF, обработки ошибок в случае зашифрованных файлов.
	•	Тестирование функций взаимодействия с OpenAI API на корректное формирование и получение ответов.
	•	Интеграционные тесты: Проверяют взаимодействие между различными модулями. Примеры:
	•	Совместная работа pdf_processing.py и openai_api.py при загрузке и анализе PDF-файлов.
	•	Проверка генерации отчетов с использованием данных от OpenAI и отправки их пользователю.
	•	Функциональные тесты: Имитируют поведение пользователя для проверки работоспособности основных функций. Примеры:
	•	Загрузка PDF-файла и генерация отчета.
	•	Обработка ошибок при загрузке неподдерживаемых файлов или сбоях в OpenAI API.

9.4 Пример структуры тестов и тестовых данных

Для структурирования тестов создайте в корне проекта папку tests со следующей организацией:

telegram_case_bot/
├── tests/
│   ├── test_pdf_processing.py      # Тесты для обработки PDF
│   ├── test_openai_api.py          # Тесты для OpenAI API
│   ├── test_report_generator.py    # Тесты для генерации отчетов
│   └── test_bot_integration.py     # Интеграционные тесты

Пример теста для функции извлечения текста из PDF:

# tests/test_pdf_processing.py
import pytest
from pdf_processing import extract_text_from_pdf

def test_extract_text_from_standard_pdf():
    sample_pdf_path = "tests/samples/standard_case.pdf"
    extracted_text = extract_text_from_pdf(sample_pdf_path)
    assert extracted_text != "", "Извлечение текста должно быть успешным"

def test_extract_text_from_encrypted_pdf():
    encrypted_pdf_path = "tests/samples/encrypted_case.pdf"
    with pytest.raises(Exception):
        extract_text_from_pdf(encrypted_pdf_path)

9.5 Обеспечение полноты тестирования

Для поддержания высокого уровня покрытия кода тестами рекомендуется:

	•	Поддерживать покрытие кода тестами не ниже 80%: Используйте команду coverage report для анализа и целевого добавления тестов.
	•	Регулярно анализировать покрытие кода: Обновляйте и расширяйте тесты по мере добавления нового функционала.
	•	Автоматически генерировать HTML-отчеты с coverage html для наглядного контроля покрытия кода.

Заключение

Эти инструкции и улучшения тестового покрытия помогут выявить ошибки на ранних этапах, повысить стабильность и качество Telegram Case Bot, а также упростят отладку для разработчиков.

9.6 Обеспечение полноты тестирования

Для поддержания высокого уровня покрытия кода тестами важно учитывать следующие аспекты:

	•	Покрытие тестами: Рекомендуется, чтобы проект имел покрытие кода тестами не ниже 80%. Для измерения покрытия можно использовать библиотеку coverage, которая предоставляет отчеты о тестовом покрытии каждого модуля. Это помогает идентифицировать неохваченные тестами участки кода.
Установка и запуск команды для получения покрытия:

pip install coverage
coverage run -m pytest
coverage report


	•	Анализ покрытия кода: После выполнения команды coverage report разработчики могут увидеть детализированные результаты по каждому файлу, включая процент покрытия и строки, которые остались без тестов. Это позволяет проводить регулярный анализ и повышать уровень покрытия при добавлении новых функций или изменении существующих.
	•	Автоматическая генерация отчетов покрытия: Команда coverage html создает подробный HTML-отчет о покрытии тестами, что позволяет визуально оценить, какие части кода необходимо улучшить. Отчет можно открыть в браузере, перейдя к файлу htmlcov/index.html.

10. Мониторинг и аналитика

10.1 Система мониторинга

Для обеспечения стабильной работы Telegram Case Bot рекомендуется внедрить систему мониторинга, позволяющую отслеживать ошибки и ключевые показатели производительности в реальном времени.

	•	Интеграция с Sentry: Подключение к платформе Sentry поможет отслеживать ошибки и исключения, возникающие в процессе работы бота. Sentry позволяет получить полную информацию об ошибках, включая трассировки стека, окружение и метаданные, что значительно облегчает диагностику и устранение проблем.
	•	Сбор метрик с Prometheus и визуализация с Grafana: Для глубинного мониторинга производительности можно использовать Prometheus для сбора метрик, таких как:
	•	Количество запросов от пользователей,
	•	Время отклика на запросы,
	•	Статистика ошибок по модулям (pdf_processing, openai_api и т. д.).
С помощью Grafana эти метрики можно визуализировать, что поможет легко анализировать и выявлять узкие места в работе бота.

10.2 Сбор пользовательских данных

Чтобы понять, как пользователи взаимодействуют с ботом, можно организовать сбор обезличенных данных, не нарушая конфиденциальности пользователей. Это позволит выявить популярные команды и средние значения времени отклика.

	•	Сбор метрик команд: Обезличенные данные об использовании команд позволят анализировать популярность отдельных функций, что поможет принимать решения о приоритетах дальнейших улучшений. Например:
	•	Отслеживание количества загрузок кейсов,
	•	Анализ частоты обращений к функциям анализа и генерации отчетов.
	•	Среднее время отклика: Вычисление среднего времени отклика бота для каждой команды может помочь в выявлении задержек в процессе анализа и обработки PDF, что позволит оптимизировать производительность системы.
	•	Анализ узких мест: Регулярный анализ метрик и логов помогает выявить узкие места в производительности, такие как перегрузка на этапе анализа или генерации отчетов. Дальнейшая оптимизация этих этапов может существенно повысить общую эффективность бота.

Заключение

Добавление мониторинга и аналитики в Telegram Case Bot позволит своевременно выявлять и устранять проблемы, повышая качество обслуживания и эффективность работы.

10.3 Расширенные метрики использования

Для более детального анализа работы Telegram Case Bot и повышения качества пользовательского опыта предлагается внедрить дополнительные метрики использования. Эти метрики позволят отслеживать поведение пользователей, выявлять слабые места в интерфейсе и оптимизировать производительность системы.

1. Точки отказа

Эта метрика фиксирует этапы взаимодействия, на которых пользователи покидают бота, что позволяет выявить слабые места в интерфейсе или процессе обработки данных. Например, пользователи могут часто покидать бота после загрузки PDF-файла, если не получают быстрого отклика или при возникновении ошибок. Анализ таких точек поможет улучшить интерфейс и оптимизировать процесс взаимодействия.

Техническая реализация:

	•	В каждом основном блоке взаимодействия (загрузка файла, обработка данных, получение отчета) добавить логирование с идентификатором пользователя и временной меткой.
	•	Фиксировать данные о выходе пользователя в логах в случае, если бот не получает ответа или подтверждения на следующем этапе.
	•	Использовать систему аналитики, такую как Prometheus, для сбора и анализа данных по этим меткам и визуализации в Grafana.

Пример кода логирования точки отказа:

import logging

def track_user_interaction(stage, user_id):
    logging.info(f"User {user_id} reached stage: {stage}")
    
# Пример использования
track_user_interaction("upload_pdf", user_id)

2. Среднее время на выполнение запроса

Эта метрика позволяет отслеживать и измерять время выполнения каждого запроса пользователя, включая этапы анализа и генерации отчета. Среднее время на выполнение запроса поможет выявить узкие места и оценить производительность системы, особенно на этапах, связанных с обращениями к OpenAI API и генерацией PDF-отчета.

Техническая реализация:

	•	При каждом запросе добавлять временную метку начала и завершения операции.
	•	Расчёт среднего времени выполнения запросов через периодическое вычисление и запись в логи или в базу данных.
	•	Использовать инструменты мониторинга, такие как Prometheus и Grafana, для отслеживания и визуализации среднего времени выполнения запросов, что поможет в настройке оповещений на случай аномалий в производительности.

Пример кода для отслеживания времени выполнения:

import time
import logging

def measure_request_time(stage, user_id):
    start_time = time.time()
    
    # Логика выполнения запроса
    
    end_time = time.time()
    elapsed_time = end_time - start_time
    logging.info(f"User {user_id} - Stage {stage} completed in {elapsed_time:.2f} seconds")
    
    return elapsed_time

# Пример использования
measure_request_time("generate_report", user_id)

Интеграция с системой мониторинга и визуализации

Для эффективного отслеживания этих метрик можно интегрировать Telegram Case Bot с такими инструментами, как Prometheus для сбора метрик и Grafana для визуализации и анализа. Это позволит наглядно видеть точки отказа и среднее время обработки запросов, быстро выявлять проблемы и предпринимать меры для их решения.

Заключение

Внедрение расширенных метрик использования позволит не только улучшить взаимодействие с пользователями, но и повысить производительность системы, выявляя узкие места в обработке данных и анализируя наиболее критичные этапы работы бота.

11. Обработка конфиденциальных данных

11.1 Политика хранения данных

Telegram Case Bot обрабатывает конфиденциальные данные пользователей, такие как загружаемые PDF-файлы. Для обеспечения безопасности и соблюдения норм по защите данных рекомендуется следующая политика:

	•	Временное хранение PDF-файлов: Загружаемые пользователями PDF-документы временно хранятся на сервере до завершения обработки. После формирования отчета файлы должны быть удалены автоматически, чтобы предотвратить их накопление и снизить риск несанкционированного доступа.
	•	Временные данные обработки: Любые промежуточные данные, создаваемые на этапе анализа и генерации отчетов, также должны удаляться после завершения сессии, чтобы минимизировать объем хранимой информации.
	•	Срок хранения: Если хранение данных необходимо, должно быть установлено строгое ограничение по срокам хранения (например, 24 часа), по истечении которых все временные данные автоматически удаляются.

11.2 Защита конфиденциальности пользователей

	•	Шифрование данных: Данные, обрабатываемые ботом, шифруются с использованием алгоритма AES-256 перед их передачей на серверы OpenAI для анализа. Это защищает данные от несанкционированного доступа.
	•	Ограничение доступа: Доступ к конфиденциальным данным ограничивается только системой Telegram Case Bot и ответственными администраторами. Обычные пользователи или посторонние лица не имеют доступа к данным, проходящим через бота.
	•	Анонимизация данных: При сборе метрик и статистики взаимодействий, данные пользователей должны обезличиваться. Это позволяет отслеживать работу бота и выявлять узкие места, не нарушая конфиденциальности пользователей.

11.3 Политика удаления данных

	•	Автоматическая очистка: Данные должны удаляться автоматически по завершении обработки запроса. Это касается как исходных PDF-файлов, так и любых временных файлов, созданных в процессе анализа.
	•	Информация для пользователей: Пользователи должны быть уведомлены о политике обработки и удаления данных, например, через пользовательское соглашение или всплывающее сообщение в боте. Это поможет создать прозрачность и уверенность в защите конфиденциальности.

Заключение

Применение строгой политики хранения и удаления данных в Telegram Case Bot гарантирует защиту конфиденциальной информации пользователей, снижает риски утечек данных и обеспечивает соответствие нормативным требованиям по защите данных.

11.4 Соответствие нормативам GDPR

Telegram Case Bot обрабатывает и временно хранит данные пользователей в строгом соответствии с положениями Общего регламента по защите данных (GDPR). Это включает обработку данных с учётом принципов прозрачности, минимизации хранения и защиты конфиденциальности.

Сбор и хранение данных

	•	Минимизация хранения данных: Вся информация пользователей хранится только в течение минимально необходимого периода для выполнения операции (например, анализа кейса или генерации отчета). По завершении обработки данные автоматически удаляются, чтобы предотвратить их ненужное накопление и снизить риск утечек.
	•	Временное хранение данных: Telegram Case Bot использует временные хранилища для загружаемых PDF-документов и промежуточных данных. Как только обработка завершается и отчет передается пользователю, все временные файлы, включая загруженные PDF и сгенерированные промежуточные данные, полностью удаляются.

Анонимизация данных и аналитика

	•	Анонимизация и псевдонимизация: При сборе обезличенных аналитических данных о взаимодействии пользователей (например, частота использования функций, среднее время обработки) Telegram Case Bot обезличивает информацию, сохраняя только агрегированные данные. Это позволяет анализировать функциональность и улучшать качество сервиса без нарушения конфиденциальности пользователей.

Обеспечение безопасности и прав пользователей

	•	Защита данных и права пользователей: Доступ к любым конфиденциальным данным строго ограничен только для системы бота и ответственных администраторов, что соответствует требованиям GDPR. Пользователи могут обратиться к администраторам для получения информации о своих данных, требовать их удаления или исправления.

Политика удаления данных

	•	Автоматическое удаление данных: Вся информация пользователя, связанная с обработкой данных (включая PDF-документы и результаты анализа), удаляется автоматически по завершении задачи или после окончания сессии, если пользователь не запрашивает её сохранение на определенный срок.

12. Примеры и инструкции для разработчиков

12.1 Пример API-запросов к OpenAI

Для корректного взаимодействия Telegram Case Bot с OpenAI API важно понимать структуру запросов и ожидаемых ответов. Примеры приведённых запросов и ответов помогут разработчикам быстрее интегрировать и тестировать систему.

Пример базового запроса к OpenAI API:

import openai

def analyze_case_text(text: str) -> str:
    openai.api_key = "your_openai_api_key"
    response = openai.Completion.create(
        model="text-davinci-003",
        prompt=text,
        max_tokens=500,
        temperature=0.7,
    )
    return response.choices[0].text.strip()

# Пример использования функции
text_to_analyze = "Анализ политического кейса..."
result = analyze_case_text(text_to_analyze)
print(result)

Описание параметров:

	•	model: Название модели для обработки текста, например, text-davinci-003.
	•	prompt: Текст, который требуется проанализировать.
	•	max_tokens: Ограничение на количество токенов в ответе.
	•	temperature: Параметр управления креативностью ответа. Низкие значения (например, 0.2) делают ответ более определённым, высокие (например, 0.8) — более вариативным.

Ожидаемая структура ответа

OpenAI возвращает JSON-объект, содержащий несколько полей. Основное значение для обработки находится в choices[0].text.

Пример ответа:

{
    "id": "cmpl-6eUJFI9xG0Ev8rTj8J",
    "object": "text_completion",
    "created": 1672257592,
    "model": "text-davinci-003",
    "choices": [
        {
            "text": "\nРезультаты анализа: Несколько ключевых несостыковок в кейсе включают...",
            "index": 0,
            "logprobs": null,
            "finish_reason": "length"
        }
    ],
    "usage": {
        "prompt_tokens": 10,
        "completion_tokens": 500,
        "total_tokens": 510
    }
}

12.2 Пример структуры сообщений для пользователей

Для улучшения пользовательского опыта и унификации ответов рекомендуется использовать стандартные сообщения для разных ситуаций. Это поможет пользователям понять суть сообщений и повысить удобство использования бота.

Примеры стандартных сообщений:

	•	Приветственное сообщение:

Привет! Я — Telegram Case Bot. Загрузите PDF-файл с политическим кейсом, и я проанализирую его для вас.


	•	Сообщение о принятии пользовательского соглашения:

Пожалуйста, подтвердите, что вы принимаете пользовательское соглашение, чтобы продолжить загрузку и анализ кейсов.


	•	Сообщение об успешной загрузке файла:

Ваш файл успешно загружен. Начинается обработка и анализ, это может занять несколько минут.


	•	Сообщение об ошибке загрузки файла:

Ошибка загрузки файла. Убедитесь, что загружаемый файл является PDF и его размер не превышает установленный лимит.


	•	Сообщение об ошибке взаимодействия с OpenAI API:

Произошла ошибка при анализе кейса. Пожалуйста, попробуйте снова позже. Если проблема повторяется, обратитесь в техническую поддержку.


	•	Сообщение об успешном завершении анализа:

Анализ завершен! Вот ваш отчет:


	•	Сообщение об уведомлении и ошибке API:

Извините, но в данный момент система перегружена. Пожалуйста, попробуйте позже или свяжитесь с поддержкой.



Заключение

Примеры API-запросов и шаблонов сообщений помогают унифицировать ответы и упростить интеграцию. Это также гарантирует, что пользователи получают точные и понятные уведомления, а разработчики быстрее ориентируются в системе.

12.4 Локальное тестирование и разработка

Для удобства разработки и тестирования Telegram Case Bot локально рекомендуется следовать приведенным ниже инструкциям по настройке окружения, установке зависимостей и созданию файлов с тестовыми данными.

1. Пример настройки окружения

Чтобы настроить окружение для локального тестирования и разработки, выполните следующие шаги:

Шаг 1. Установка Python и виртуального окружения

Убедитесь, что на вашей системе установлен Python 3.10. Затем создайте и активируйте виртуальное окружение для управления зависимостями проекта.

# Установите Python 3.10, если еще не установлен
# В Linux (например, Ubuntu):
sudo apt update
sudo apt install python3.10 python3.10-venv python3.10-dev

# Создание и активация виртуального окружения
cd path/to/telegram_case_bot
python3.10 -m venv venv
source venv/bin/activate  # для Linux/macOS
# или venv\Scripts\activate  # для Windows

Шаг 2. Установка зависимостей

Установите зависимости, указанные в requirements.txt, чтобы ваш проект мог корректно работать.

pip install -r requirements.txt

Шаг 3. Настройка переменных окружения

Все параметры конфигурации хранятся в файле `config.py`. 
TELEGRAM_BOT_TOKEN="ваш_токен_бота"
OPENAI_API_KEY="ваш_ключ_API_OpenAI"
ENCRYPTION_KEY="ваш_ключ_шифрования"
LOGGING_LEVEL="DEBUG"

Используйте библиотеку python-dotenv для загрузки этих переменных в код. Если она еще не установлена, добавьте ее в зависимости:

pip install python-dotenv

Пример использования в коде (например, в config.py):

import os
from dotenv import load_dotenv

load_dotenv()
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY")
LOGGING_LEVEL = os.getenv("LOGGING_LEVEL", "INFO")

2. Файлы с примерами запросов и ответов

Для локального тестирования без использования реального API OpenAI создайте набор JSON-файлов с тестовыми данными, моделирующими запросы и ответы API. Эти файлы позволят тестировать функциональность бота, не обращаясь к OpenAI.

Шаг 1. Создание тестовых данных

Создайте папку tests/mock_data и добавьте JSON-файлы с примерами запросов и ответов. Например:

	•	tests/mock_data/sample_request.json:

{
    "prompt": "Анализ политического кейса...",
    "model": "text-davinci-003",
    "max_tokens": 500,
    "temperature": 0.7
}


	•	tests/mock_data/sample_response.json:

{
    "choices": [
        {
            "text": "\nРезультаты анализа: Обнаружены ключевые несостыковки...",
            "finish_reason": "length"
        }
    ],
    "usage": {
        "prompt_tokens": 10,
        "completion_tokens": 500,
        "total_tokens": 510
    }
}



Шаг 2. Имитация ответов API

Добавьте функцию-имитатор, которая будет считывать тестовые данные и возвращать их вместо реального ответа OpenAI API:

import json

def mock_openai_request(request_data):
    """Загружает и возвращает предварительно сохраненный ответ из JSON файла для тестирования."""
    with open("tests/mock_data/sample_response.json", "r", encoding="utf-8") as file:
        mock_response = json.load(file)
    return mock_response

Пример использования mock-функции в тесте:

def test_openai_integration():
    # Имитация запроса
    with open("tests/mock_data/sample_request.json", "r", encoding="utf-8") as file:
        request_data = json.load(file)
    
    response = mock_openai_request(request_data)
    
    assert "choices" in response, "Ожидаемая структура ответа API"
    assert response["choices"][0]["text"].startswith("\nРезультаты анализа"), "Проверка текста ответа"

Заключение

Эти инструкции по локальному тестированию и созданию тестовых данных позволят разработчикам эффективно тестировать функциональность бота без необходимости в реальных запросах к OpenAI, что упрощает отладку и ускоряет процесс разработки.
